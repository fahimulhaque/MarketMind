#!/usr/bin/env bash
set -eo pipefail

# Navigation context to ensure it works regardless of where it's called from
cd "$(dirname "$0")"

# Execute with the 'full' profile active to ensure all services are recognized by start, stop, logs, etc.
export COMPOSE_PROFILES=${COMPOSE_PROFILES:-full}

# Colors for UI
GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Helper Functions
log_info() { echo -e "${BLUE}‚ÑπÔ∏è  $1${NC}"; }
log_success() { echo -e "${GREEN}‚úÖ $1${NC}"; }
log_error() { echo -e "${RED}‚ùå $1${NC}"; }

check_docker() {
    if ! command -v docker >/dev/null 2>&1; then
        log_error "Docker is not installed. Please install Docker Desktop or equivalent."
        exit 1
    fi
    if ! docker info >/dev/null 2>&1; then
        log_error "Docker daemon is not running. Please start Docker."
        exit 1
    fi
}

setup_env() {
    if [ ! -f .env ]; then
        log_info "No .env found. Bootstrapping from .env.example..."
        if [ -f .env.example ]; then
            cp .env.example .env
            log_success "Created .env file."
        else
            log_error "No .env.example found to bootstrap from."
            exit 1
        fi
    fi
}

start_services() {
    check_docker
    setup_env

    log_info "Starting up services (this might take a moment to pull images)..."
    
    # --remove-orphans keeps things clean if services were removed from the compose file
    docker compose up -d --remove-orphans

    log_success "All services started."
    print_dashboard
}

print_dashboard() {
    echo -e "\n${GREEN}üöÄ MarketMind is running!${NC}"
    echo "----------------------------------------------------"
    echo -e "üì± ${BLUE}Dashboard UI:${NC}    http://localhost:3000"
    echo -e "üß† ${BLUE}API Gateway:${NC}     http://localhost:8000/docs"
    echo -e "üóÑÔ∏è  ${BLUE}Database:${NC}        localhost:5432"
    echo -e "üí¨ ${BLUE}Ollama:${NC}          http://localhost:11434"
    echo "----------------------------------------------------"
    echo "Useful commands:"
    echo "  ./marketmind logs       - View streaming, colorized logs for all services"
    echo "  ./marketmind stop       - Stop services (keeps data)"
    echo "  ./marketmind down       - Stop and remove containers"
    echo "  ./marketmind clean      - Full atomic teardown (DANGER: clear db volumes)"
    echo ""
}

print_help() {
    echo -e "\n${GREEN}üß† MarketMind CLI${NC}"
    echo -e "An orchestration wrapper for local development.\n"
    
    echo -e "${YELLOW}Usage:${NC} ./marketmind [command] [service]"
    echo ""
    echo -e "${YELLOW}Lifecycle Commands:${NC}"
    echo -e "  ${GREEN}start${NC}           - Bootstrap environment and start all services in the background."
    echo -e "  ${GREEN}stop${NC}            - Gracefully stop all services (retains data)."
    echo -e "  ${GREEN}down${NC}            - Spin down containers and networks (retains volumes)."
    echo -e "  ${GREEN}clean${NC}           - Atomic teardown! Destroys containers, DB volumes, and uninstalls local deps."
    echo ""
    echo -e "${YELLOW}Granular Control:${NC}"
    echo -e "  ${BLUE}status${NC}          - Show running status and health of the MarketMind stack."
    echo -e "  ${BLUE}logs${NC} [service]  - Tail streaming logs (e.g., './marketmind logs', './marketmind logs api')."
    echo -e "  ${BLUE}restart${NC} [svc]   - Restart the whole stack, or just one piece (e.g., './marketmind restart worker')."
    echo -e "  ${BLUE}refresh${NC} [svc]   - Force rebuild and recreate a container (useful after changing package.json/requirements.txt)."
    echo -e "  ${BLUE}shell${NC} <service> - Drop into an interactive bash/sh prompt inside a running container."
    echo ""
    echo -e "${YELLOW}Examples:${NC}"
    echo "  ./marketmind start"
    echo "  ./marketmind logs api"
    echo "  ./marketmind restart worker"
    echo "  ./marketmind shell postgres"
    echo ""
}

# CLI Router
SERVICE=$2

case "$1" in
    start|"")
        start_services
        ;;
    stop)
        log_info "Stopping MarketMind..."
        docker compose stop $SERVICE
        ;;
    down)
        log_info "Spinning down MarketMind..."
        docker compose down
        ;;
    status|ps)
        log_info "Container Status:"
        docker compose ps
        ;;
    logs)
        shift
        docker compose logs -f "$@"
        ;;
    restart)
        if [ -z "$SERVICE" ]; then
            log_info "Restarting all services..."
        else
            log_info "Restarting service: $SERVICE..."
        fi
        docker compose restart $SERVICE
        ;;
    refresh|build)
        log_info "Force rebuilding and recreating containers (Service: ${SERVICE:-All})..."
        docker compose build --no-cache $SERVICE
        docker compose up -d --force-recreate $SERVICE
        log_success "Refresh complete."
        ;;
    shell|exec)
        if [ -z "$SERVICE" ]; then
            log_error "You must specify a service to shell into (e.g., './marketmind shell api')."
            exit 1
        fi
        log_info "Dropping into $SERVICE..."
        # Try bash first, fallback to sh if bash isn't installed (like in alpine images)
        docker compose exec $SERVICE /bin/sh -c "command -v bash >/dev/null 2>&1 && exec bash || exec sh"
        ;;
    clean)
        echo -e "${YELLOW}WARNING: This will destroy all local data volumes (Postgres, Redis, Ollama).${NC}"
        read -p "Are you sure? [y/N]: " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            docker compose down -v --remove-orphans --rmi local
            rm -rf .venv node_modules
            log_success "Cleaned up all containers, volumes, and local dependencies."
        else
            echo -e "\nCleanup cancelled."
        fi
        ;;
    help|-h|--help)
        print_help
        ;;
    *)
        log_error "Unknown command: $1"
        print_help
        exit 1
        ;;
esac
